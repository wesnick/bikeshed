<div class="card mt-3">
  <div class="card-body">
    <h4 class="h5 card-title mb-3">Create New Stash</h4>
    <form hx-post="/stashes"
          hx-ext="form-json"
          hx-swap="none"
          hx-on::after-request="processStashCreation(event)">
      <input type="hidden" name="entity_id" value="{{ entity_id }}">
      <input type="hidden" name="entity_type" value="{{ entity_type }}">
      <div class="mb-3">
        <label class="form-label" for="new-stash-name-{{ entity_id }}">Name</label>
        <input class="form-control" type="text" id="new-stash-name-{{ entity_id }}" name="name" required>
      </div>
      <div class="mb-3">
        <label class="form-label" for="new-stash-description-{{ entity_id }}">Description</label>
        <textarea class="form-control" id="new-stash-description-{{ entity_id }}" name="description" rows="3"></textarea>
      </div>
      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary">Create</button>
        <button type="button" class="btn btn-secondary" onclick="closeStashForm()">Cancel</button>
      </div>
    </form>
  </div>
</div>
<script>
  function closeStashForm() {
    // Ensure this ID exists where the form is loaded, or pass the container ID dynamically
    const container = document.getElementById('stash-form-container');
    if (container) {
      container.innerHTML = '';
    }
  }
  
  function processStashCreation(event) {
    const response = JSON.parse(event.detail.xhr.responseText);
    if (response && response.id) {
      // Add the new stash to the entity
      htmx.ajax('POST', '/stashes/entity', {
        target: '#entity-stashes-container', // Ensure this target ID exists on the page
        swap: 'innerHTML',
        values: {
          entity_id: '{{ entity_id }}',
          entity_type: '{{ entity_type }}',
          stash_id: response.id
        }
      });
      
      // Close the form
      closeStashForm();
    }
  }
</script>
