<div class="stash-selector" id="stash-selector-{{ entity_id }}">
  <div class="mb-2"> {# Changed from field to mb-2 for tighter spacing if desired #}
    <label class="form-label small">Stashes</label> {# Made label small #}
    <div class="dropdown" id="stash-dropdown-{{ entity_id }}"> {# Unique ID for dropdown #}
      <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100" type="button" 
              id="stashDropdownButton-{{ entity_id }}" 
              data-bs-toggle="dropdown" aria-expanded="false"
              hx-get="/stashes/components/entity-stashes?entity_id={{ entity_id }}&entity_type={{ entity_type }}"
              hx-target="#entity-stashes-container-{{ entity_id }}">
        Add Stashes <i class="fas fa-angle-down ms-1"></i>
      </button>
      <ul class="dropdown-menu w-100" aria-labelledby="stashDropdownButton-{{ entity_id }}">
        {% for stash in stashes %}
          <li>
            <a class="dropdown-item" href="#"
               hx-post="/stashes/entity"
               hx-vals='{"entity_id": "{{ entity_id }}", "entity_type": "{{ entity_type }}", "stash_id": "{{ stash.id }}"}'
               hx-target="#entity-stashes-container-{{ entity_id }}"
               hx-swap="innerHTML">{{ stash.name }}</a>
          </li>
        {% endfor %}
        {% if stashes %}<li><hr class="dropdown-divider"></li>{% endif %}
        <li>
          <div class="p-2">
            <button class="btn btn-sm btn-primary w-100"
                    hx-get="/stashes/components/create-stash-form?entity_id={{ entity_id }}&entity_type={{ entity_type }}"
                    hx-target="#stash-form-container-{{ entity_id }}">Create New Stash</button>
          </div>
        </li>
      </ul>
    </div>
  </div>
  <div id="entity-stashes-container-{{ entity_id }}">
    {# This content is loaded by HTMX from entity_stashes.html.j2, which was already converted. #}
    {# If there's initial content here, it needs to match the converted entity_stashes.html.j2 format. #}
    {% if entity_stashes %}
      <div class="stashes">
        {% for stash in entity_stashes %}
          <div class="border rounded p-2 mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fw-bold small">{{ stash.name }}</span>
              <button type="button" class="btn-close btn-sm"
                      aria-label="Remove stash"
                      hx-delete="/stashes/entity"
                      hx-vals='{"entity_id": "{{ entity_id }}", "entity_type": "{{ entity_type }}", "stash_id": "{{ stash.id }}"}'
                      hx-target="#entity-stashes-container-{{ entity_id }}"></button>
            </div>
            <p class="small text-muted mb-0">{{ stash.items|length }} items</p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted small">No stashes assigned</p>
    {% endif %}
  </div>
  <div id="stash-form-container-{{ entity_id }}"></div>
</div>
{# Removed Bulma-specific JavaScript for dropdown toggling #}
